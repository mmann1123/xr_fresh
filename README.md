# xr_fresh
[![python](https://img.shields.io/badge/Python-3.8%20%7C%203.9%20%7C%203.10%20%7C%203.11-3776AB.svg?style=flat&logo=python&logoColor=white)](https://www.python.org)
[![](https://img.shields.io/github/v/release/mmann1123/xr_fresh?display_name=tag)](https://github.com/mmann1123/xr_fresh/releases)
[![](https://img.shields.io/badge/License-MIT-black.svg)](https://github.com/jgrss/geowombat/blob/main/LICENSE.txt)
<!-- 
[![](https://github.com/mmann1123/xr_fresh/actions/workflows/python-tests.yml/badge.svg)](https://github.com/mmann1123/xr_fresh/actions/workflows/python-tests.yml)
-->


xr_fresh is designed to quickly generate a broad set of temporal features from gridded raster data time series. NOTE: This only works on single band images, not multiband e.g. rgb etc

It is a python package for analyzing time-series characteristics from raster data in `xarray` format as generated by `geowombat`.
It allows feature extraction, dimension reduction and applications of machine learning techniques for geospatial data.

- input data : historical raster data (e.g. Monthly temperature data (2000-2018)
- extracted features: Mean, minimum, maximum, variance, standard deviation... of the input data
- output: rasters with features as columns or raster file with features as bands

Example outputs:

![png](examples/output_8_0.png)

# Install

To install xr_fresh, you can use pip. However, since xr_fresh includes a C++ extension module, it requires compilation during the installation process. Here are the steps to install xr_fresh:

## Prerequisites

- Conda or mamba [Instructions here](https://docs.conda.io/projects/conda/en/latest/user-guide/install/index.html)
- C++ compiler (e.g., g++ on Linux, clang on macOS, or MSVC on Windows)

*Linux, OSx & Windows Install*

```
# add dependency
conda create -n xr_fresh geowombat -c conda-forge
conda activate xr_fresh
# clone repository
cd # to desired location
git clone https://github.com/mmann1123/xr_fresh
cd xr_fresh
pip install -U pip setuptools wheel
pip install . 
```  
Note: If you run into problems related to `rle` try running `python setup.py build_ext --inplace` from the `xr_fresh` directory


## Example

Simple working example

``` python
import os
from glob import glob
import geowombat as gw
from xr_fresh.feature_calculator_series import *


# create list of desired series
feature_list = {
    "minimum": [{}],
    "abs_energy": [{}],
    "mean_abs_change": [{}],
    "variance_larger_than_standard_deviation": [{}],
    "ratio_beyond_r_sigma": [{"r": 1}, {"r": 2}, {"r": 3}],
    "symmetry_looking": [{}],
    "sum_values": [{}],
}

# get list of evi time series images
os.chdir("~/xr_fresh/xr_fresh/data")
files = glob("tests/data/evi*.tif")

out_path = "EVI_diff_from_299.tif"
# use rasterio to create a new file tif file

with gw.series(files) as src:
    src.apply(
        longest_strike_above_mean(mean=299),
        bands=1,
        num_workers=12,
        outfile=out_path,
    )
```

Execute across multiple features and parameters

```
# Set up error logging
import logging
logging.basicConfig(
    filename="../features/error_log.log",
    level=logging.ERROR,
    format="%(asctime)s:%(levelname)s:%(message)s",
)

with gw.series( files) as src:
            # iterate across functions in feature list
            for func_name, param_list in feature_list.items():
                for params in param_list:

                    # instantiate function & get parameter
                    func_class = function_mapping.get(func_name)
                    if func_class:
                        func_instance = func_class(
                            **params
                        )  # Instantiate with parameters
                        if len(params) > 0:
                            print(f"Instantiated {func_name} with  {params}")
                        else:
                            print(f"Instantiated {func_name} ")

                    # create output file name if parameters exist
                    if len(list(params.keys())) > 0:
                        key_names = list(params.keys())[0]
                        value_names = list(params.values())[0]
                        outfile = f"{band_name}_{func_name}_{key_names}_{value_names}_{grid}.tif"
                        # avoid issue with all dates
                        if func_name in ["doy_of_maximum", "doy_of_minimum"]:
                            outfile = f"{band_name}_{func_name}_{key_names}_{grid}.tif"
                    else:
                        outfile = f"{band_name}_{func_name}_{grid}.tif"

                    # extract features
                    try:
                        src.apply(
                            func=func_instance,
                            outfile=outfile,
                            num_workers=3,
                            processes=False,
                            bands=1,
                            kwargs={"BIGTIFF": "YES", "compress": "LZW"}, # add bigtif if files are large
                        )
                    except Exception as e:
                        logging.error(
                            f"Error extracting features from {band_name} {func_name} {grid}: {e}"
                        )
                        continue
```
 
## Documentation

After cloning the repository navigate locally to and open the [documentation](mmann1123.github.io/xr_fresh/)

 
## Citation

Please cite work as:
```
Michael Mann. (2024). mmann1123/xr_fresh: SpeedySeries (0.2.0). Zenodo. https://doi.org/10.5281/zenodo.12701466
```
[![DOI](https://zenodo.org/badge/246113186.svg)](https://zenodo.org/doi/10.5281/zenodo.12519006)
